<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Masti call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#ece5dd;
    }

    /* Top Bar */
    .topbar{
      background:#075E54;
      color:white;
      padding:15px;
      font-size:20px;
      font-weight:bold;
    }

    /* Layout */
    .container{
      display:flex;
      height:calc(100vh - 55px);
    }

    /* Sidebar */
    .sidebar{
      width:280px;
      background:white;
      border-right:1px solid #ddd;
      padding:10px;
    }

    .user{
      padding:12px;
      border-radius:10px;
      margin-bottom:8px;
      cursor:pointer;
      background:#f7f7f7;
    }
    .user:hover{
      background:#DCF8C6;
    }

    /* Main Panel */
    .main{
      flex:1;
      padding:20px;
    }

    input{
      padding:12px;
      width:250px;
      border-radius:8px;
      border:1px solid #ccc;
    }

    button{
      padding:12px 18px;
      margin-left:6px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
    }

    .callBtn{
      background:#25D366;
      color:white;
    }

    .endBtn{
      background:red;
      color:white;
    }

    .status{
      margin-top:20px;
      font-size:16px;
      font-weight:bold;
    }

    /* Incoming Call Popup */
    .popup{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      justify-content:center;
      align-items:center;
    }

    .popupBox{
      background:white;
      padding:25px;
      border-radius:15px;
      text-align:center;
      width:300px;
    }

    .accept{
      background:#25D366;
      color:white;
    }

    .reject{
      background:red;
      color:white;
    }
  </style>
</head>

<body>
  <div class="topbar">ðŸ“ž Masti call</div>

  <div class="container">

    <!-- Sidebar -->
    <div class="sidebar">
      <h3>Online Users</h3>
      <div id="onlineUsers"></div>
    </div>

    <!-- Main -->
    <div class="main">
      <h2>Call by ID</h2>

      <input id="myId" placeholder="Set Your 4-digit ID"/>
      <button id="setBtn" class="callBtn">Set ID</button>

      <br><br>

      <input id="toId" placeholder="Enter ID to Call"/>
      <button id="callBtn" class="callBtn">Call</button>
      <button id="endBtn" class="endBtn">End</button>

      <div class="status" id="status">Status: Idle</div>

      <audio id="remoteAudio" autoplay playsinline></audio>
    </div>
  </div>

  <!-- Incoming Call Popup -->
  <div class="popup" id="popup">
    <div class="popupBox">
      <h2>Incoming Call</h2>
      <p id="callerId"></p>
      <button id="acceptBtn" class="accept">Accept</button>
      <button id="rejectBtn" class="reject">Reject</button>
    </div>
  </div>

 <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
const socket = io();

let myId="", peerId="";
let pc=null, localStream=null;

const statusEl=document.getElementById("status");
const popup=document.getElementById("popup");
const callerId=document.getElementById("callerId");
const remoteAudio=document.getElementById("remoteAudio");

function setStatus(msg){
  statusEl.innerText="Status: "+msg;
}

const rtcConfig={
  iceServers:[{urls:"stun:stun.l.google.com:19302"}]
};

async function getMic(){
  if(localStream) return localStream;
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  return localStream;
}

async function setupPC(){
  pc=new RTCPeerConnection(rtcConfig);

  pc.onicecandidate=(e)=>{
    if(e.candidate){
      socket.emit("ice-candidate",{toUserId:peerId,candidate:e.candidate});
    }
  };

  pc.ontrack=(e)=>{
    remoteAudio.srcObject=e.streams[0];
  };

  const stream=await getMic();
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
}

/* Register */
document.getElementById("setBtn").onclick=()=>{
  myId=document.getElementById("myId").value.trim();
  socket.emit("register",{userId:myId});
  setStatus("Registered as "+myId);
};

/* Call */
document.getElementById("callBtn").onclick=()=>{
  peerId=document.getElementById("toId").value.trim();
  socket.emit("call-user",{toUserId:peerId});
  setStatus("Calling "+peerId+"...");
};

/* Incoming */
socket.on("incoming-call",({fromUserId})=>{
  peerId=fromUserId;
  callerId.innerText="User "+fromUserId+" is calling...";
  popup.style.display="flex";
});

/* Accept */
document.getElementById("acceptBtn").onclick=async ()=>{
  popup.style.display="none";
  socket.emit("call-accept",{toUserId:peerId});
  await setupPC();
};

/* Reject */
document.getElementById("rejectBtn").onclick=()=>{
  popup.style.display="none";
  socket.emit("call-reject",{toUserId:peerId});
  setStatus("Rejected call");
};

/* Caller Accepted â†’ Offer */
socket.on("call-accepted",async ({fromUserId})=>{
  peerId=fromUserId;
  await setupPC();

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);

  socket.emit("webrtc-offer",{toUserId:peerId,offer});
});

/* Receive Offer â†’ Answer */
socket.on("webrtc-offer",async ({fromUserId,offer})=>{
  peerId=fromUserId;
  await setupPC();

  await pc.setRemoteDescription(offer);

  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);

  socket.emit("webrtc-answer",{toUserId:peerId,answer});
});

/* Receive Answer */
socket.on("webrtc-answer",async ({answer})=>{
  await pc.setRemoteDescription(answer);
});

/* ICE */
socket.on("ice-candidate",async ({candidate})=>{
  if(candidate) await pc.addIceCandidate(candidate);
});

/* End */
document.getElementById("endBtn").onclick=()=>{
  socket.emit("end-call",{toUserId:peerId});
  setStatus("Call Ended");
};
</script>

</body>
</html>
