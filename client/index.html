<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Masti call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    body{ margin:0; font-family: Arial, sans-serif; background:#ece5dd; }

    /* Top Bar */
    .topbar{ background:#075E54; color:white; padding:15px; font-size:20px; font-weight:bold; }

    /* Layout */
    .container{ display:flex; height:calc(100vh - 55px); }

    /* Sidebar */
    .sidebar{ width:280px; background:white; border-right:1px solid #ddd; padding:10px; }

    .user{ padding:12px; border-radius:10px; margin-bottom:8px; cursor:pointer; background:#f7f7f7; }
    .user:hover{ background:#DCF8C6; }

    /* Main Panel */
    .main{ flex:1; padding:20px; }

    input{
      padding:12px; width:250px; border-radius:8px; border:1px solid #ccc;
    }

    button{
      padding:12px 18px; margin-left:6px; border:none; border-radius:8px;
      cursor:pointer; font-weight:bold;
    }

    .callBtn{ background:#25D366; color:white; }
    .endBtn{ background:red; color:white; }

    .status{ margin-top:20px; font-size:16px; font-weight:bold; }

    /* Incoming Call Popup */
    .popup{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
      justify-content:center; align-items:center; z-index:20;
    }
    .popupBox{
      background:white; padding:25px; border-radius:15px; text-align:center; width:300px;
    }
    .accept{ background:#25D366; color:white; }
    .reject{ background:red; color:white; }

    /* âœ… Login Modal */
    .modal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.65);
      justify-content:center; align-items:center; z-index:30;
    }
    .modalBox{
      width:340px; background:#fff; border-radius:16px; padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .modalBox h2{ margin:0 0 12px 0; }
    .modalBox input{ width:100%; box-sizing:border-box; margin:6px 0; }
    .row{ display:flex; gap:10px; margin-top:10px; }
    .row button{ flex:1; margin-left:0; }
    .small{ font-size:13px; color:#666; margin-top:8px; }
    .danger{ background:#d33; color:#fff; }
    .muted{ color:#666; }
    .pill{
      display:inline-block; background:#fff; border:1px solid #cfe6d9;
      border-radius:999px; padding:6px 10px; margin-top:10px;
    }
  </style>
</head>

<body>
  <div class="topbar">ðŸ“ž Masti call</div>

  <div class="container">

    <!-- Sidebar -->
    <div class="sidebar">
      <h3>Online Users</h3>
      <div id="onlineUsers"></div>
    </div>

    <!-- Main -->
    <div class="main">
      <h2>Call by ID</h2>

      <!-- âœ… My ID auto show -->
      <div class="pill">
        Your ID: <b id="myIdText">Not logged in</b>
      </div>

      <br><br>

      <!-- Keep existing input but readonly now -->
      <input id="myId" placeholder="Your 4-digit ID" readonly />
      <button id="setBtn" class="callBtn" disabled>Set ID</button>

      <button id="logoutBtn" class="danger" style="margin-left:10px;">Logout</button>

      <br><br>

      <input id="toId" placeholder="Enter ID to Call"/>
      <button id="callBtn" class="callBtn">Call</button>
      <button id="endBtn" class="endBtn">End</button>

      <div class="status" id="status">Status: Idle</div>

      <audio id="remoteAudio" autoplay playsinline></audio>
    </div>
  </div>

  <!-- Incoming Call Popup -->
  <div class="popup" id="popup">
    <div class="popupBox">
      <h2>Incoming Call</h2>
      <p id="callerId"></p>
      <button id="acceptBtn" class="accept">Accept</button>
      <button id="rejectBtn" class="reject">Reject</button>
    </div>
  </div>

  <!-- âœ… Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modalBox">
      <h2>Login</h2>
      <input id="phone" placeholder="Phone (e.g. 017xxxxxxxx)" />
      <input id="name" placeholder="Name (optional)" />
      <div class="row">
        <button id="loginBtn" class="callBtn">Login</button>
        <button id="clearBtn" class="danger">Clear</button>
      </div>
      <div class="small" id="loginMsg"></div>
      <div class="small muted">Login à¦•à¦°à¦²à§‡ à¦†à¦ªà¦¨à¦¾à¦° 4-digit ID auto-save à¦¥à¦¾à¦•à¦¬à§‡, à¦ªà¦°à§‡à¦°à¦¬à¦¾à¦° auto-login à¦¹à¦¬à§‡à¥¤</div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
/** =========================
 * âœ… Auth + Auto-login Setup
 * ========================== */

// If same origin (recommended), keep empty.
// If server is on another port/host, set like "http://localhost:3000"
const API_BASE = "";

function setAuth(token, userId){
  localStorage.setItem("token", token);
  localStorage.setItem("userId", userId);
}
function clearAuth(){
  localStorage.removeItem("token");
  localStorage.removeItem("userId");
}
function getToken(){
  return localStorage.getItem("token");
}
function getSavedUserId(){
  return localStorage.getItem("userId");
}

async function api(path, opts={}){
  const token = getToken();
  const headers = { "Content-Type":"application/json", ...(opts.headers||{}) };
  if(token) headers.Authorization = "Bearer " + token;

  const res = await fetch(API_BASE + path, { ...opts, headers });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(data.error || "Request failed");
  return data;
}

const loginModal = document.getElementById("loginModal");
const loginMsg = document.getElementById("loginMsg");
const myIdText = document.getElementById("myIdText");

function openLogin(msg=""){
  loginMsg.textContent = msg;
  loginModal.style.display = "flex";
}
function closeLogin(){
  loginModal.style.display = "none";
}

function setMyIdUI(id){
  document.getElementById("myId").value = id || "";
  myIdText.textContent = id || "Not logged in";
}

async function doRegisterSocket(userId){
  // register to socket system (your existing server expects 4-digit)
  socket.emit("register", { userId });
}

async function autoLogin(){
  const token = getToken();
  const savedId = getSavedUserId();

  if(!token || !savedId){
    setMyIdUI("");
    openLogin("Please login to get your default ID.");
    return;
  }

  try{
    const me = await api("/auth/me");
    setMyIdUI(me.userId);
    closeLogin();
    await doRegisterSocket(me.userId);
    setStatus("Registered as " + me.userId);
  }catch(e){
    clearAuth();
    setMyIdUI("");
    openLogin("Session expired. Please login again.");
  }
}

document.getElementById("loginBtn").onclick = async () => {
  loginMsg.textContent = "Logging in...";
  try{
    const phone = document.getElementById("phone").value.trim();
    const name  = document.getElementById("name").value.trim();
    const data = await api("/auth/login", {
      method:"POST",
      body: JSON.stringify({ phone, name })
    });

    setAuth(data.token, data.userId);

    // confirm
    const me = await api("/auth/me");
    setMyIdUI(me.userId);
    closeLogin();
    await doRegisterSocket(me.userId);
    setStatus("Registered as " + me.userId);
  }catch(e){
    loginMsg.textContent = e.message;
  }
};

document.getElementById("clearBtn").onclick = () => {
  document.getElementById("phone").value = "";
  document.getElementById("name").value = "";
  loginMsg.textContent = "";
};

document.getElementById("logoutBtn").onclick = () => {
  clearAuth();
  setMyIdUI("");
  openLogin("Logged out. Please login again.");
  setStatus("Idle");
};


/** =========================
 * âœ… Your Existing Call App
 * ========================== */

const socket = io();

let myId="", peerId="";
let pc=null, localStream=null;

const statusEl=document.getElementById("status");
const popup=document.getElementById("popup");
const callerId=document.getElementById("callerId");
const remoteAudio=document.getElementById("remoteAudio");

function setStatus(msg){
  statusEl.innerText="Status: "+msg;
}

const rtcConfig={
  iceServers:[{urls:"stun:stun.l.google.com:19302"}]
};

async function getMic(){
  if(localStream) return localStream;
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  return localStream;
}

async function setupPC(){
  pc=new RTCPeerConnection(rtcConfig);

  pc.onicecandidate=(e)=>{
    if(e.candidate){
      socket.emit("ice-candidate",{toUserId:peerId,candidate:e.candidate});
    }
  };

  pc.ontrack=(e)=>{
    remoteAudio.srcObject=e.streams[0];
  };

  const stream=await getMic();
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
}

/* Keep Set ID button disabled (login handles it) */
document.getElementById("setBtn").onclick=()=>{};

/* Call */
document.getElementById("callBtn").onclick=()=>{
  const saved = getSavedUserId();
  if(!saved){
    openLogin("Please login first.");
    return;
  }
  peerId=document.getElementById("toId").value.trim();
  socket.emit("call-user",{toUserId:peerId});
  setStatus("Calling "+peerId+"...");
};

/* Incoming */
socket.on("incoming-call",({fromUserId})=>{
  peerId=fromUserId;
  callerId.innerText="User "+fromUserId+" is calling...";
  popup.style.display="flex";
});

/* Accept */
document.getElementById("acceptBtn").onclick=async ()=>{
  popup.style.display="none";
  socket.emit("call-accept",{toUserId:peerId});
  await setupPC();
};

/* Reject */
document.getElementById("rejectBtn").onclick=()=>{
  popup.style.display="none";
  socket.emit("call-reject",{toUserId:peerId});
  setStatus("Rejected call");
};

/* Caller Accepted â†’ Offer */
socket.on("call-accepted",async ({fromUserId})=>{
  peerId=fromUserId;
  await setupPC();

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);

  socket.emit("webrtc-offer",{toUserId:peerId,offer});
});

/* Receive Offer â†’ Answer */
socket.on("webrtc-offer",async ({fromUserId,offer})=>{
  peerId=fromUserId;
  await setupPC();

  await pc.setRemoteDescription(offer);

  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);

  socket.emit("webrtc-answer",{toUserId:peerId,answer});
});

/* Receive Answer */
socket.on("webrtc-answer",async ({answer})=>{
  await pc.setRemoteDescription(answer);
});

/* ICE */
socket.on("ice-candidate",async ({candidate})=>{
  if(candidate) await pc.addIceCandidate(candidate);
});

/* End */
document.getElementById("endBtn").onclick=()=>{
  socket.emit("end-call",{toUserId:peerId});
  setStatus("Call Ended");
};

/* Online users list (optional show in sidebar) */
socket.on("online-users", ({users}) => {
  const wrap = document.getElementById("onlineUsers");
  wrap.innerHTML = "";
  users.forEach(u => {
    const div = document.createElement("div");
    div.className = "user";
    div.textContent = `${u.id} (${u.status})`;
    div.onclick = () => {
      document.getElementById("toId").value = u.id;
    };
    wrap.appendChild(div);
  });
});

/* Handle force logout when same ID used elsewhere */
socket.on("force-logout", ({message}) => {
  clearAuth();
  setMyIdUI("");
  openLogin(message || "Logged out.");
  setStatus("Idle");
});

/* Basic errors */
socket.on("error-msg", ({message}) => setStatus(message || "Error"));
socket.on("busy", ({toUserId}) => setStatus(`User ${toUserId} is busy`));
socket.on("user-offline", ({toUserId}) => setStatus(`User ${toUserId} is offline`));
socket.on("call-rejected", ({fromUserId}) => setStatus(`Call rejected by ${fromUserId}`));
socket.on("call-ended", ({fromUserId}) => setStatus(`Call ended (${fromUserId})`));

/* Start auto-login on load */
autoLogin();
</script>

</body>
</html>
